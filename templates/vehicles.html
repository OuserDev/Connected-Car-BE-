<!DOCTYPE html>
<html>
    <head>
        <title>ì°¨ëŸ‰ ê´€ë¦¬ - Connected Car Service</title>
        <meta charset="utf-8" />
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background: #f5f5f5;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .header {
                text-align: center;
                color: #333;
                margin-bottom: 30px;
            }
            .section {
                margin-bottom: 30px;
                padding: 20px;
                border: 1px solid #ddd;
                border-radius: 5px;
                background: #fafafa;
            }
            .section h3 {
                color: #2c5aa0;
                margin-top: 0;
            }
            .form-group {
                margin-bottom: 15px;
            }
            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }
            .form-group input,
            .form-group select {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }
            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                margin-right: 10px;
                font-size: 14px;
            }
            .btn-primary {
                background: #2c5aa0;
                color: white;
            }
            .btn-success {
                background: #28a745;
                color: white;
            }
            .btn-warning {
                background: #ffc107;
                color: #212529;
            }
            .btn-danger {
                background: #dc3545;
                color: white;
            }
            .btn:hover {
                opacity: 0.8;
            }
            .car-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }
            .car-card {
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 15px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
            .car-card h4 {
                margin: 0 0 10px 0;
                color: #2c5aa0;
            }
            .car-info {
                font-size: 14px;
                margin-bottom: 8px;
            }
            .car-status {
                display: flex;
                gap: 10px;
                margin: 15px 0;
            }
            .status-badge {
                padding: 4px 8px;
                border-radius: 3px;
                font-size: 12px;
                font-weight: bold;
            }
            .status-on {
                background: #d4edda;
                color: #155724;
            }
            .status-off {
                background: #f8d7da;
                color: #721c24;
            }
            .status-locked {
                background: #fff3cd;
                color: #856404;
            }
            .status-unlocked {
                background: #cce7ff;
                color: #004085;
            }
            .controls {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                margin-top: 10px;
            }
            .controls .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            #result {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                padding: 15px;
                margin-top: 20px;
                white-space: pre-wrap;
                font-family: monospace;
                max-height: 300px;
                overflow-y: auto;
            }
            .location-info {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ğŸš— ì°¨ëŸ‰ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                <p>Connected Car Service - ì°¨ëŸ‰ ë“±ë¡ ë° ì›ê²© ì œì–´</p>
            </div>

            <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
            <div class="section">
                <h3>ë¡œê·¸ì¸</h3>
                <div style="display: flex; gap: 20px; align-items: end">
                    <div class="form-group" style="flex: 1">
                        <label>ì‚¬ìš©ìëª…</label>
                        <input id="loginUser" placeholder="username" value="user1" />
                    </div>
                    <div class="form-group" style="flex: 1">
                        <label>ë¹„ë°€ë²ˆí˜¸</label>
                        <input id="loginPass" type="password" placeholder="password" value="user123" />
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
                        <button class="btn btn-warning" onclick="checkAuthStatus()">ìƒíƒœí™•ì¸</button>
                    </div>
                </div>
            </div>

            <!-- ì°¨ëŸ‰ ë“±ë¡ ì„¹ì…˜ -->
            <div class="section">
                <h3>ğŸ” ì°¨ëŸ‰ ë“±ë¡ (VIN ë˜ëŠ” ì°¨ëŸ‰ë²ˆí˜¸ë¡œ ê²€ìƒ‰)</h3>
                <div style="display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 15px; align-items: end">
                    <div class="form-group">
                        <label>VIN ë²ˆí˜¸</label>
                        <input id="searchVin" placeholder="ì˜ˆ: KMHL14JA1PA123456" style="text-transform: uppercase" />
                    </div>
                    <div class="form-group">
                        <label>ì°¨ëŸ‰ë²ˆí˜¸</label>
                        <input id="searchLicense" placeholder="ì˜ˆ: 12ê°€3456" />
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="registerCarBySearch()">ì°¨ëŸ‰ ë“±ë¡</button>
                    </div>
                </div>
                <div style="margin-top: 15px">
                    <button class="btn btn-success" onclick="loadAvailableCars()">ë“±ë¡ ê°€ëŠ¥í•œ ì°¨ëŸ‰ ëª©ë¡ ë³´ê¸°</button>
                </div>
            </div>

            <!-- ë“±ë¡ ê°€ëŠ¥í•œ ì°¨ëŸ‰ ëª©ë¡ ì„¹ì…˜ -->
            <div class="section" id="availableCarsSection" style="display: none">
                <h3>ğŸš— ë“±ë¡ ê°€ëŠ¥í•œ ì°¨ëŸ‰ ëª©ë¡</h3>
                <div id="availableCarsList" class="car-grid"></div>
            </div>

            <!-- ì‚¬ìš©ì í”„ë¡œí•„ ì„¹ì…˜ -->
            <div class="section">
                <h3>ğŸ‘¤ ë‚´ í”„ë¡œí•„</h3>
                <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="loadUserProfile()">í”„ë¡œí•„ ì¡°íšŒ</button>
                    <button class="btn btn-success" onclick="showProfileEditForm()">í”„ë¡œí•„ ìˆ˜ì •</button>
                    <button class="btn" style="background: #6f42c1; color: white;" onclick="showCardManagement()">ğŸ’³ ì¹´ë“œ ê´€ë¦¬</button>
                </div>
                
                <div id="profileInfo" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <div id="profileContent"></div>
                </div>

                <!-- í”„ë¡œí•„ ìˆ˜ì • í¼ -->
                <div id="profileEditForm" style="display: none; background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <h4>í”„ë¡œí•„ ìˆ˜ì •</h4>
                    <div class="form-group">
                        <label>ì´ë¦„</label>
                        <input id="editName" placeholder="ì´ë¦„" />
                    </div>
                    <div class="form-group">
                        <label>ì „í™”ë²ˆí˜¸</label>
                        <input id="editPhone" placeholder="010-0000-0000" />
                    </div>
                    <div class="form-group">
                        <label>ì´ë©”ì¼</label>
                        <input id="editEmail" type="email" placeholder="email@example.com" />
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="updateProfile()">ì €ì¥</button>
                        <button class="btn btn-danger" onclick="cancelProfileEdit()">ì·¨ì†Œ</button>
                    </div>
                </div>

                <!-- ì¹´ë“œ ê´€ë¦¬ ì„¹ì…˜ -->
                <div id="cardManagement" style="display: none; background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <h4>ğŸ’³ ë“±ë¡ëœ ê²°ì œ ì¹´ë“œ</h4>
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="loadPaymentCards()">ì¹´ë“œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                        <button class="btn btn-success" onclick="showAddCardForm()">ìƒˆ ì¹´ë“œ ì¶”ê°€</button>
                    </div>
                    <div id="cardsList"></div>
                    
                    <!-- ì¹´ë“œ ì¶”ê°€ í¼ -->
                    <div id="addCardForm" style="display: none; background: #e8f5e8; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <h5>ìƒˆ ì¹´ë“œ ì¶”ê°€</h5>
                        <div class="form-group">
                            <label>ì¹´ë“œ ë²ˆí˜¸</label>
                            <input id="newCardNumber" placeholder="1234567890123456" maxlength="16" />
                        </div>
                        <div class="form-group">
                            <label>ì¹´ë“œëª…</label>
                            <select id="newCardName">
                                <option value="í˜„ëŒ€ì¹´ë“œ">í˜„ëŒ€ì¹´ë“œ</option>
                                <option value="ì‹ í•œì¹´ë“œ">ì‹ í•œì¹´ë“œ</option>
                                <option value="ì‚¼ì„±ì¹´ë“œ">ì‚¼ì„±ì¹´ë“œ</option>
                                <option value="KBêµ­ë¯¼ì¹´ë“œ">KBêµ­ë¯¼ì¹´ë“œ</option>
                                <option value="í•˜ë‚˜ì¹´ë“œ">í•˜ë‚˜ì¹´ë“œ</option>
                                <option value="ìš°ë¦¬ì¹´ë“œ">ìš°ë¦¬ì¹´ë“œ</option>
                                <option value="NHë†í˜‘ì¹´ë“œ">NHë†í˜‘ì¹´ë“œ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ìœ íš¨ê¸°ê°„ (MM/YY)</label>
                            <input id="newCardExpiry" placeholder="12/25" maxlength="5" />
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="addPaymentCard()">ì¹´ë“œ ì¶”ê°€</button>
                            <button class="btn btn-danger" onclick="cancelAddCard()">ì·¨ì†Œ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë‚´ ì°¨ëŸ‰ ëª©ë¡ ì„¹ì…˜ -->
            <div class="section">
                <h3>ë‚´ ì°¨ëŸ‰ ëª©ë¡</h3>
                <button class="btn btn-primary" onclick="loadMyCars()">ìƒˆë¡œê³ ì¹¨</button>
                <div id="carsList" class="car-grid"></div>
            </div>

            <!-- ê´€ë¦¬ì ì „ìš© ê¸°ëŠ¥ë“¤ì€ ë³„ë„ ê´€ë¦¬ì VMì—ì„œ ê°œë°œ ì˜ˆì • -->

            <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
            <div id="result"></div>
        </div>

        <script>
            const API = `http://${window.location.hostname}:8000`;
            let currentUser = null;

            function log(data) {
                document.getElementById('result').textContent = JSON.stringify(data, null, 2);
            }

            // ë¡œê·¸ì¸
            async function login() {
                const res = await fetch(`${API}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: document.getElementById('loginUser').value,
                        password: document.getElementById('loginPass').value,
                    }),
                });
                const data = await res.json();
                log(data);

                if (res.ok && data.status === 'success') {
                    currentUser = data.user;
                    loadMyCars();
                }
            }

            // ì¸ì¦ ìƒíƒœ í™•ì¸
            async function checkAuthStatus() {
                const res = await fetch(`${API}/api/auth/status`, { credentials: 'include' });
                const data = await res.json();
                log(data);

                if (res.ok && data.authenticated) {
                    currentUser = data.user;
                }
            }

            // VIN ë˜ëŠ” ì°¨ëŸ‰ë²ˆí˜¸ë¡œ ì°¨ëŸ‰ ë“±ë¡
            async function registerCarBySearch() {
                const vin = document.getElementById('searchVin').value.trim();
                const license = document.getElementById('searchLicense').value.trim();

                if (!vin && !license) {
                    log({ error: 'VIN ë²ˆí˜¸ ë˜ëŠ” ì°¨ëŸ‰ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' });
                    return;
                }

                const payload = {};
                if (vin) payload.vin = vin;
                if (license) payload.license_plate = license;

                const res = await fetch(`${API}/api/cars/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                log(data);

                if (res.ok) {
                    loadMyCars();
                    loadAvailableCars(); // ë“±ë¡ ê°€ëŠ¥í•œ ì°¨ëŸ‰ ëª©ë¡ë„ ìƒˆë¡œê³ ì¹¨
                    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    document.getElementById('searchVin').value = '';
                    document.getElementById('searchLicense').value = '';
                }
            }

            // ì°¨ëŸ‰ IDë¡œ ì§ì ‘ ë“±ë¡ (ë“±ë¡ ê°€ëŠ¥í•œ ì°¨ëŸ‰ ëª©ë¡ì—ì„œ ì„ íƒ ì‹œ)
            async function registerCarById(carId) {
                const res = await fetch(`${API}/api/cars/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ car_id: carId }),
                });
                const data = await res.json();
                log(data);

                if (res.ok) {
                    loadMyCars();
                    loadAvailableCars(); // ë“±ë¡ ê°€ëŠ¥í•œ ì°¨ëŸ‰ ëª©ë¡ë„ ìƒˆë¡œê³ ì¹¨
                }
            }

            // ë“±ë¡ ê°€ëŠ¥í•œ ì°¨ëŸ‰ ëª©ë¡ ì¡°íšŒ
            async function loadAvailableCars() {
                const res = await fetch(`${API}/api/cars/available`, { credentials: 'include' });
                const data = await res.json();

                if (res.ok) {
                    displayAvailableCars(data.cars);
                    document.getElementById('availableCarsSection').style.display = 'block';
                    log({ message: `${data.cars.length}ëŒ€ì˜ ë“±ë¡ ê°€ëŠ¥í•œ ì°¨ëŸ‰ì„ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.`, cars: data.cars });
                } else {
                    log(data);
                }
            }

            // ë‚´ ì°¨ëŸ‰ ëª©ë¡ ì¡°íšŒ
            async function loadMyCars() {
                const res = await fetch(`${API}/api/cars`, { credentials: 'include' });
                const data = await res.json();

                if (res.ok) {
                    displayCars(data.cars, 'carsList');
                    log({ message: `${data.cars.length}ëŒ€ì˜ ì°¨ëŸ‰ì„ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.`, cars: data.cars });
                } else {
                    log(data);
                }
            }

            // ê´€ë¦¬ì ì „ìš© í•¨ìˆ˜ë“¤ ì œê±°ë¨ - ë³„ë„ ê´€ë¦¬ì VMì—ì„œ êµ¬í˜„ ì˜ˆì •

            // ì°¨ëŸ‰ ì œì–´
            async function controlCar(carId, action) {
                const res = await fetch(`${API}/api/car/${carId}/command?action=${action}`, {
                    method: 'POST',
                    credentials: 'include',
                });
                const data = await res.json();
                log(data);

                if (res.ok) {
                    loadMyCars(); // ì œì–´ í›„ ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                }
            }

            // ì°¨ëŸ‰ ìƒíƒœ ì¡°íšŒ
            async function getCarStatus(carId) {
                const res = await fetch(`${API}/api/car/${carId}/status`, { credentials: 'include' });
                const data = await res.json();
                log(data);
            }

            // ë“±ë¡ ê°€ëŠ¥í•œ ì°¨ëŸ‰ ëª©ë¡ í‘œì‹œ
            function displayAvailableCars(cars) {
                const container = document.getElementById('availableCarsList');
                if (!cars || cars.length === 0) {
                    container.innerHTML = '<p>ë“±ë¡ ê°€ëŠ¥í•œ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                container.innerHTML = cars
                    .map((car) => {
                        const location = car.location || {};

                        return `
                    <div class="car-card" style="border: 2px dashed #28a745;">
                        <h4>í˜„ëŒ€ ${car.model} (${car.year}) <span style="color: #28a745;">âœ¨ ë“±ë¡ ê°€ëŠ¥</span></h4>
                        <div class="car-info">ì°¨ëŸ‰ ID: ${car.id}</div>
                        <div class="car-info">VIN: ${car.vin || 'N/A'}</div>
                        <div class="car-info">ì°¨ëŸ‰ë²ˆí˜¸: ${car.license_plate || 'ë¯¸ë“±ë¡'}</div>
                        <div class="car-info">ì—°ë£Œ: ${car.fuel}% | ë°°í„°ë¦¬: ${car.battery}V (${car.voltage || '12V'})</div>
                        <div class="location-info">ğŸ“ ${location.lat ? `ìœ„ë„: ${location.lat}, ê²½ë„: ${location.lng}` : 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ'}</div>
                        ${car.specs ? `
                        <div class="specs-info" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;">
                            <strong>ğŸ“‹ ì°¨ëŸ‰ ìŠ¤í™</strong><br>
                            â€¢ ë¶„ë¥˜: ${car.specs.category} (${car.specs.segment})<br>
                            â€¢ ì—”ì§„: ${car.specs.engine_type} ${car.specs.displacement || ''}<br>
                            â€¢ ì¶œë ¥: ${car.specs.power}<br>
                            ${car.specs.fuel_efficiency ? `â€¢ ì—°ë¹„: ${car.specs.fuel_efficiency}` : ''}
                            ${car.specs.range ? `â€¢ ì£¼í–‰ê±°ë¦¬: ${car.specs.range}` : ''}
                        </div>` : ''}
                        
                        <div class="controls" style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="registerCarById(${car.id})" style="width: 100%; padding: 10px;">
                                ğŸš— ë‚´ ì°¨ëŸ‰ìœ¼ë¡œ ë“±ë¡í•˜ê¸°
                            </button>
                        </div>
                    </div>
                `;
                    })
                    .join('');
            }

            // ì°¨ëŸ‰ ëª©ë¡ í‘œì‹œ
            function displayCars(cars, containerId, showOwner = false) {
                const container = document.getElementById(containerId);
                if (!cars || cars.length === 0) {
                    container.innerHTML = '<p>ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                container.innerHTML = cars
                    .map((car) => {
                        const engineClass = car.engine_state === 'on' ? 'status-on' : 'status-off';
                        const doorClass = car.door_state === 'locked' ? 'status-locked' : 'status-unlocked';
                        const location = car.location || {};

                        return `
                    <div class="car-card">
                        <h4>í˜„ëŒ€ ${car.model} (${car.year})</h4>
                        <div class="car-info">ì°¨ëŸ‰ ID: ${car.id}</div>
                        ${showOwner ? `<div class="car-info">ì†Œìœ ì ID: ${car.owner_id}</div>` : ''}
                        <div class="car-info">VIN: ${car.vin || 'N/A'}</div>
                        <div class="car-info">ì°¨ëŸ‰ë²ˆí˜¸: ${car.license_plate || 'ë¯¸ë“±ë¡'}</div>
                        <div class="car-info">ì—°ë£Œ: ${car.fuel}% | ë°°í„°ë¦¬: ${car.battery}V (${car.voltage || '12V'})</div>
                        <div class="location-info">ğŸ“ ${location.lat ? `ìœ„ë„: ${location.lat}, ê²½ë„: ${location.lng}` : 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ'}</div>
                        ${car.specs ? `
                        <div class="specs-info" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;">
                            <strong>ğŸ“‹ ì°¨ëŸ‰ ìŠ¤í™</strong><br>
                            â€¢ ë¶„ë¥˜: ${car.specs.category} (${car.specs.segment})<br>
                            â€¢ ì—”ì§„: ${car.specs.engine_type} ${car.specs.displacement || ''}<br>
                            â€¢ ì¶œë ¥: ${car.specs.power}<br>
                            ${car.specs.fuel_efficiency ? `â€¢ ì—°ë¹„: ${car.specs.fuel_efficiency}` : ''}
                            ${car.specs.range ? `â€¢ ì£¼í–‰ê±°ë¦¬: ${car.specs.range}` : ''}
                        </div>` : ''}
                        
                        <div class="car-status">
                            <span class="status-badge ${engineClass}">ì‹œë™ ${car.engine_state === 'on' ? 'ON' : 'OFF'}</span>
                            <span class="status-badge ${doorClass}">ë„ì–´ ${car.door_state === 'locked' ? 'ì ê¸ˆ' : 'ì—´ë¦¼'}</span>
                        </div>
                        
                        ${car.climate ? `
                        <div class="climate-info" style="margin: 10px 0; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 12px;">
                            <strong>â„ï¸ ê³µì¡°ê¸° ìƒíƒœ</strong><br>
                            â€¢ AC: ${car.climate.ac_state === 'on' ? 'ğŸŸ¢ ON' : 'âšª OFF'} | íˆí„°: ${car.climate.heater_state === 'on' ? 'ğŸŸ¢ ON' : 'âšª OFF'}<br>
                            â€¢ ì„¤ì •ì˜¨ë„: ${car.climate.target_temp}Â°C | í˜„ì¬ì˜¨ë„: ${car.climate.current_temp}Â°C<br>
                            â€¢ íŒ¬ì†ë„: ${car.climate.fan_speed}/7 | ìë™ëª¨ë“œ: ${car.climate.auto_mode ? 'ğŸŸ¢ ON' : 'âšª OFF'}
                        </div>
                        ` : ''}
                        
                        ${car.tire_pressure ? `
                        <div class="tire-info" style="margin: 10px 0; padding: 8px; background: #fff3cd; border-radius: 4px; font-size: 12px;">
                            <strong>ğŸ› íƒ€ì´ì–´ ì••ë ¥ (${car.tire_pressure.unit || 'bar'})</strong><br>
                            â€¢ ì•ì¢Œ: ${car.tire_pressure.front_left} | ì•ìš°: ${car.tire_pressure.front_right}<br>
                            â€¢ ë’¤ì¢Œ: ${car.tire_pressure.rear_left} | ë’¤ìš°: ${car.tire_pressure.rear_right}<br>
                            â€¢ ê¶Œì¥: ${car.tire_pressure.recommended} | ê²½ê³ : ${car.tire_pressure.warning_threshold} ì´í•˜<br>
                            ${car.tire_pressure.front_left < car.tire_pressure.warning_threshold || 
                              car.tire_pressure.front_right < car.tire_pressure.warning_threshold ||
                              car.tire_pressure.rear_left < car.tire_pressure.warning_threshold ||
                              car.tire_pressure.rear_right < car.tire_pressure.warning_threshold ? 
                              '<span style="color: red; font-weight: bold;">âš ï¸ íƒ€ì´ì–´ ì••ë ¥ ë¶€ì¡±!</span>' : 
                              '<span style="color: green;">âœ… ì••ë ¥ ì •ìƒ</span>'}
                        </div>
                        ` : ''}
                        
                        ${car.odometer ? `
                        <div class="odometer-info" style="margin: 10px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;">
                            <strong>ğŸ“Š ì£¼í–‰ ì •ë³´</strong><br>
                            â€¢ ì´ ì£¼í–‰ê±°ë¦¬: ${car.odometer.total_km.toLocaleString()}km<br>
                            â€¢ Trip A: ${car.odometer.trip_a_km}km | Trip B: ${car.odometer.trip_b_km}km<br>
                            â€¢ ìµœì¢… ì—…ë°ì´íŠ¸: ${new Date(car.odometer.last_updated).toLocaleDateString()}
                        </div>
                        ` : ''}
                        
                        <div class="controls">
                            <button class="btn btn-success" onclick="controlCar(${car.id}, 'engine_on')">ì‹œë™ ON</button>
                            <button class="btn btn-danger" onclick="controlCar(${car.id}, 'engine_off')">ì‹œë™ OFF</button>
                            <button class="btn btn-warning" onclick="controlCar(${car.id}, 'door_lock')">ë„ì–´ ì ê¸ˆ</button>
                            <button class="btn btn-primary" onclick="controlCar(${car.id}, 'door_unlock')">ë„ì–´ ì—´ê¸°</button>
                            <button class="btn" style="background:#6c757d;color:white;" onclick="getCarStatus(${car.id})">ìƒíƒœ ì¡°íšŒ</button>
                        </div>
                        
                        <div class="location-controls" style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn" style="background: #ffc107; color: black; font-weight: bold;" onclick="hornAndLocate(${car.id})">ğŸ”Š ê²½ì  & ìœ„ì¹˜</button>
                            <button class="btn" style="background: #20c997; color: white;" onclick="getLocation(${car.id})">ğŸ“ ìœ„ì¹˜ ì¡°íšŒ</button>
                        </div>
                        
                        <div class="climate-controls" style="margin-top: 10px; padding: 8px; background: #f0f8ff; border-radius: 4px;">
                            <strong>â„ï¸ ê³µì¡°ê¸° ì œì–´</strong>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px;">
                                <button class="btn" style="font-size: 11px; padding: 4px 8px; background: #17a2b8; color: white;" onclick="controlCar(${car.id}, 'ac_on')">AC ON</button>
                                <button class="btn" style="font-size: 11px; padding: 4px 8px; background: #6c757d; color: white;" onclick="controlCar(${car.id}, 'ac_off')">AC OFF</button>
                                <button class="btn" style="font-size: 11px; padding: 4px 8px; background: #fd7e14; color: white;" onclick="controlCar(${car.id}, 'heater_on')">íˆí„° ON</button>
                                <button class="btn" style="font-size: 11px; padding: 4px 8px; background: #6c757d; color: white;" onclick="controlCar(${car.id}, 'heater_off')">íˆí„° OFF</button>
                            </div>
                            <div style="margin-top: 8px;">
                                <label style="font-size: 11px;">ì˜¨ë„ ì„¤ì •:</label>
                                <select id="temp_${car.id}" style="font-size: 11px; margin: 0 5px;" onchange="setTemperature(${car.id}, this.value)">
                                    ${Array.from({length: 15}, (_, i) => 16 + i).map(temp => 
                                        `<option value="${temp}" ${car.climate && car.climate.target_temp === temp ? 'selected' : ''}>${temp}Â°C</option>`
                                    ).join('')}
                                </select>
                                <select id="fan_${car.id}" style="font-size: 11px;" onchange="setFanSpeed(${car.id}, this.value)">
                                    ${Array.from({length: 8}, (_, i) => i).map(speed => 
                                        `<option value="${speed}" ${car.climate && car.climate.fan_speed === speed ? 'selected' : ''}>íŒ¬ ${speed}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="tire-controls" style="margin-top: 10px;">
                            <button class="btn" style="background: #dc3545; color: white; font-size: 11px; padding: 6px 8px; width: 100%;" onclick="checkTirePressure(${car.id})">ğŸ› íƒ€ì´ì–´ ì••ë ¥ ì ê²€</button>
                        </div>
                        
                        <div class="driving-controls" style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                            <button class="btn" style="background: #28a745; color: white; font-size: 11px; padding: 6px 8px;" onclick="getDrivingStatistics(${car.id})">ğŸ“Š ì£¼í–‰í†µê³„</button>
                            <button class="btn" style="background: #007bff; color: white; font-size: 11px; padding: 6px 8px;" onclick="getTripHistory(${car.id})">ğŸ“‹ ì£¼í–‰ì´ë ¥</button>
                        </div>
                    </div>
                `;
                    })
                    .join('');
            }

            // ì˜¨ë„ ì„¤ì • í•¨ìˆ˜
            function setTemperature(carId, temperature) {
                controlCarWithValue(carId, 'temp_set', temperature);
            }

            // íŒ¬ ì†ë„ ì„¤ì • í•¨ìˆ˜  
            function setFanSpeed(carId, speed) {
                controlCarWithValue(carId, 'fan_speed', speed);
            }

            // ê°’ì´ ìˆëŠ” ì°¨ëŸ‰ ì œì–´ í•¨ìˆ˜
            async function controlCarWithValue(carId, action, value) {
                try {
                    const response = await fetch(`${API}/api/car/${carId}/command?action=${action}&value=${value}`, {
                        method: 'POST',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (response.ok) {
                        log(data);
                        // ì„±ê³µ í›„ ì°¨ëŸ‰ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        loadMyCars();
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // ê²½ì  + ìœ„ì¹˜ ì¡°íšŒ í•¨ìˆ˜
            async function hornAndLocate(carId) {
                try {
                    const response = await fetch(`${API}/api/car/${carId}/horn`, {
                        method: 'POST',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (response.ok) {
                        log(data);
                        // ê²½ì  í›„ ì°¨ëŸ‰ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸ ë°˜ì˜)
                        loadMyCars();
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // ìœ„ì¹˜ ì¡°íšŒ í•¨ìˆ˜
            async function getLocation(carId) {
                try {
                    const response = await fetch(`${API}/api/car/${carId}/location`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (response.ok) {
                        log(data);
                        // ìœ„ì¹˜ ì¡°íšŒ í›„ ì°¨ëŸ‰ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸ ë°˜ì˜)
                        loadMyCars();
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // íƒ€ì´ì–´ ì••ë ¥ ì²´í¬ í•¨ìˆ˜
            async function checkTirePressure(carId) {
                try {
                    const response = await fetch(`${API}/api/car/${carId}/tire-pressure`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (response.ok) {
                        log(data);
                        // íƒ€ì´ì–´ ì••ë ¥ ì²´í¬ í›„ ì°¨ëŸ‰ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        loadMyCars();
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // íƒ€ì´ì–´ ì••ë ¥ ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜
            async function simulateTirePressure(carId) {
                try {
                    const response = await fetch(`${API}/api/car/${carId}/tire-pressure/simulate`, {
                        method: 'POST',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (response.ok) {
                        log(data);
                        // ì‹œë®¬ë ˆì´ì…˜ í›„ ì°¨ëŸ‰ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        loadMyCars();
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // ì£¼í–‰ í†µê³„ ì¡°íšŒ í•¨ìˆ˜
            async function getDrivingStatistics(carId) {
                try {
                    const response = await fetch(`${API}/api/car/${carId}/driving-statistics`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (response.ok) {
                        log(data);
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // ì£¼í–‰ ì´ë ¥ ì¡°íšŒ í•¨ìˆ˜
            async function getTripHistory(carId) {
                try {
                    const response = await fetch(`${API}/api/car/${carId}/trip-history?limit=5`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (response.ok) {
                        log(data);
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // ì£¼í–‰ ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜
            async function simulateTrip(carId) {
                try {
                    const response = await fetch(`${API}/api/car/${carId}/simulate-trip`, {
                        method: 'POST',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (response.ok) {
                        log(data);
                        // ì‹œë®¬ë ˆì´ì…˜ í›„ ì°¨ëŸ‰ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì˜¤ë„ë¯¸í„°, ì—°ë£Œ ë“± ì—…ë°ì´íŠ¸)
                        loadMyCars();
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // ì‚¬ìš©ì í”„ë¡œí•„ ì¡°íšŒ
            async function loadUserProfile() {
                try {
                    const response = await fetch(`${API}/api/auth/profile`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (response.ok) {
                        displayUserProfile(data);
                        document.getElementById('profileInfo').style.display = 'block';
                        log(data);
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // í”„ë¡œí•„ í‘œì‹œ í•¨ìˆ˜
            function displayUserProfile(profile) {
                const content = document.getElementById('profileContent');
                content.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>ì‚¬ìš©ìëª…:</strong> ${profile.username}</div>
                        <div><strong>ì´ë©”ì¼:</strong> ${profile.email || 'ë¯¸ì„¤ì •'}</div>
                        <div><strong>ì´ë¦„:</strong> ${profile.name || 'ë¯¸ì„¤ì •'}</div>
                        <div><strong>ì „í™”ë²ˆí˜¸:</strong> ${profile.phone || 'ë¯¸ì„¤ì •'}</div>
                        <div><strong>ë“±ë¡ ì°¨ëŸ‰:</strong> ${profile.owned_cars ? profile.owned_cars.length : 0}ëŒ€</div>
                        <div><strong>ê°€ì…ì¼:</strong> ${new Date(profile.created_at).toLocaleDateString()}</div>
                    </div>
                `;
            }

            // í”„ë¡œí•„ ìˆ˜ì • í¼ í‘œì‹œ
            function showProfileEditForm() {
                loadUserProfile();
                document.getElementById('profileEditForm').style.display = 'block';
                
                // í˜„ì¬ ì •ë³´ë¡œ í¼ ì±„ìš°ê¸°
                setTimeout(async () => {
                    try {
                        const response = await fetch(`${API}/api/auth/profile`, { credentials: 'include' });
                        const profile = await response.json();
                        if (response.ok) {
                            document.getElementById('editName').value = profile.name || '';
                            document.getElementById('editPhone').value = profile.phone || '';
                            document.getElementById('editEmail').value = profile.email || '';
                        }
                    } catch (error) {
                        console.error('í”„ë¡œí•„ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    }
                }, 100);
            }

            // í”„ë¡œí•„ ì—…ë°ì´íŠ¸
            async function updateProfile() {
                try {
                    const name = document.getElementById('editName').value;
                    const phone = document.getElementById('editPhone').value;
                    const email = document.getElementById('editEmail').value;

                    const response = await fetch(`${API}/api/auth/profile`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ name, phone, email })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        log(data);
                        loadUserProfile(); // ì—…ë°ì´íŠ¸ëœ í”„ë¡œí•„ ë‹¤ì‹œ ë¡œë“œ
                        cancelProfileEdit(); // í¼ ìˆ¨ê¸°ê¸°
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // í”„ë¡œí•„ ìˆ˜ì • ì·¨ì†Œ
            function cancelProfileEdit() {
                document.getElementById('profileEditForm').style.display = 'none';
            }

            // ì¹´ë“œ ê´€ë¦¬ í‘œì‹œ
            function showCardManagement() {
                document.getElementById('cardManagement').style.display = 'block';
                loadPaymentCards();
            }

            // ê²°ì œ ì¹´ë“œ ëª©ë¡ ë¡œë“œ
            async function loadPaymentCards() {
                try {
                    const response = await fetch(`${API}/api/auth/cards`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (response.ok) {
                        displayPaymentCards(data.cards);
                        log(data);
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // ê²°ì œ ì¹´ë“œ í‘œì‹œ
            function displayPaymentCards(cards) {
                const container = document.getElementById('cardsList');
                if (!cards || cards.length === 0) {
                    container.innerHTML = '<p>ë“±ë¡ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                container.innerHTML = cards.map(card => `
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold;">${card.card_name} ${card.is_default ? 'â­ (ê¸°ë³¸ì¹´ë“œ)' : ''}</div>
                            <div style="color: #666; font-size: 14px;">${card.card_number}</div>
                            <div style="color: #888; font-size: 12px;">ìœ íš¨ê¸°ê°„: ${card.expiry_date}</div>
                        </div>
                        <div>
                            ${!card.is_default ? `<button class="btn" style="background: #ffc107; color: black; font-size: 12px; margin-right: 5px;" onclick="setDefaultCard(${card.id})">ê¸°ë³¸ì„¤ì •</button>` : ''}
                            <button class="btn btn-danger" style="font-size: 12px;" onclick="removePaymentCard(${card.id})">ì‚­ì œ</button>
                        </div>
                    </div>
                `).join('');
            }

            // ì¹´ë“œ ì¶”ê°€ í¼ í‘œì‹œ
            function showAddCardForm() {
                document.getElementById('addCardForm').style.display = 'block';
            }

            // ìƒˆ ì¹´ë“œ ì¶”ê°€
            async function addPaymentCard() {
                try {
                    const card_number = document.getElementById('newCardNumber').value;
                    const card_name = document.getElementById('newCardName').value;
                    const expiry_date = document.getElementById('newCardExpiry').value;

                    if (!card_number || !card_name || !expiry_date) {
                        log({ error: 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' });
                        return;
                    }

                    const response = await fetch(`${API}/api/auth/cards`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ card_number, card_name, expiry_date })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        log(data);
                        loadPaymentCards(); // ì¹´ë“œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        cancelAddCard(); // í¼ ìˆ¨ê¸°ê¸°
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // ì¹´ë“œ ì¶”ê°€ ì·¨ì†Œ
            function cancelAddCard() {
                document.getElementById('addCardForm').style.display = 'none';
                document.getElementById('newCardNumber').value = '';
                document.getElementById('newCardExpiry').value = '';
            }

            // ì¹´ë“œ ì‚­ì œ
            async function removePaymentCard(cardId) {
                if (!confirm('ì´ ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                try {
                    const response = await fetch(`${API}/api/auth/cards/${cardId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (response.ok) {
                        log(data);
                        loadPaymentCards(); // ì¹´ë“œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // ê¸°ë³¸ ì¹´ë“œ ì„¤ì •
            async function setDefaultCard(cardId) {
                try {
                    const response = await fetch(`${API}/api/auth/cards/${cardId}/default`, {
                        method: 'PUT',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (response.ok) {
                        log(data);
                        loadPaymentCards(); // ì¹´ë“œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } else {
                        log(data);
                    }
                } catch (error) {
                    log({ error: error.message });
                }
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ìƒíƒœ í™•ì¸
            window.addEventListener('load', function () {
                checkAuthStatus();
            });
        </script>
    </body>
</html>
