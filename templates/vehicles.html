<!DOCTYPE html>
<html>
    <head>
        <title>ì°¨ëŸ‰ API í…ŒìŠ¤íŠ¸ - Connected Car Service</title>
        <meta charset="utf-8" />
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background: #f5f5f5;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                padding: 20px;
                border-radius: 8px;
            }
            .header {
                text-align: center;
                color: #333;
                margin-bottom: 20px;
            }
            .section {
                margin-bottom: 20px;
                padding: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            .section h3 {
                color: #2c5aa0;
                margin-top: 0;
            }
            .form-group {
                margin-bottom: 10px;
            }
            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }
            .form-group input,
            .form-group select {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            .btn {
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                margin: 2px;
                font-size: 12px;
            }
            .btn-primary {
                background: #2c5aa0;
                color: white;
            }
            .btn-success {
                background: #28a745;
                color: white;
            }
            .btn-warning {
                background: #ffc107;
                color: #212529;
            }
            .btn-danger {
                background: #dc3545;
                color: white;
            }
            .btn:hover {
                opacity: 0.8;
            }
            .car-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: 15px;
                margin-top: 15px;
            }
            .car-card {
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 15px;
            }
            .car-card h4 {
                margin: 0 0 10px 0;
                color: #2c5aa0;
            }
            .car-info {
                font-size: 13px;
                margin-bottom: 5px;
            }
            .car-status {
                display: flex;
                gap: 8px;
                margin: 10px 0;
            }
            .status-badge {
                padding: 3px 6px;
                border-radius: 3px;
                font-size: 11px;
                font-weight: bold;
            }
            .status-on {
                background: #d4edda;
                color: #155724;
            }
            .status-off {
                background: #f8d7da;
                color: #721c24;
            }
            .status-locked {
                background: #fff3cd;
                color: #856404;
            }
            .status-unlocked {
                background: #cce7ff;
                color: #004085;
            }
            .controls {
                display: flex;
                flex-wrap: wrap;
                gap: 3px;
                margin-top: 8px;
            }
            .controls .btn {
                padding: 4px 8px;
                font-size: 11px;
            }
            #result {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                padding: 15px;
                margin-top: 20px;
                white-space: pre-wrap;
                font-family: monospace;
                max-height: 400px;
                overflow-y: auto;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ğŸš— Vehicle API Test</h1>
                <p>Connected Car Service API Testing Interface</p>
            </div>

            <!-- ì¸ì¦ ì„¹ì…˜ -->
            <div class="section">
                <h3>ğŸ” Authentication</h3>
                <div style="display: flex; gap: 15px; align-items: end">
                    <div class="form-group" style="flex: 1">
                        <label>Username</label>
                        <input id="loginUser" placeholder="username" value="user1" />
                    </div>
                    <div class="form-group" style="flex: 1">
                        <label>Password</label>
                        <input id="loginPass" type="password" placeholder="password" value="user123" />
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="login()">Login</button>
                        <button class="btn btn-warning" onclick="checkAuthStatus()">Status</button>
                    </div>
                </div>
            </div>

            <!-- ì°¨ëŸ‰ ë“±ë¡ API í…ŒìŠ¤íŠ¸ -->
            <div class="section">
                <h3>ğŸ”§ Vehicle Registration API</h3>
                <div style="display: flex; gap: 10px; align-items: end; flex-wrap: wrap">
                    <div class="form-group" style="min-width: 200px">
                        <label>VIN Number</label>
                        <input id="searchVin" placeholder="KMHL14JA1PA123456" style="text-transform: uppercase" />
                    </div>
                    <div class="form-group" style="min-width: 150px">
                        <label>License Plate</label>
                        <input id="searchLicense" placeholder="12ê°€3456" />
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="registerCarBySearch()">Register</button>
                        <button class="btn btn-success" onclick="loadAvailableCars()">Available Cars</button>
                    </div>
                </div>
            </div>

            <!-- ë“±ë¡ ê°€ëŠ¥í•œ ì°¨ëŸ‰ ëª©ë¡ -->
            <div class="section" id="availableCarsSection" style="display: none">
                <h3>ğŸ“‹ Available Vehicles</h3>
                <div id="availableCarsList" class="car-grid"></div>
            </div>

            <!-- ë‚´ ì°¨ëŸ‰ ëª©ë¡ API í…ŒìŠ¤íŠ¸ -->
            <div class="section">
                <h3>ğŸš— My Vehicles API</h3>
                <div style="margin-bottom: 10px">
                    <button class="btn btn-primary" onclick="loadMyCars()">Load Vehicles</button>
                    <button class="btn btn-success" onclick="loadUserProfile()">User Profile</button>
                    <button class="btn btn-warning" onclick="testVehicleAPI()">Test Vehicle API</button>
                    <button class="btn btn-danger" onclick="testCarAPIHealth()">Check Car-API</button>
                    <button class="btn" style="background: #6f42c1; color: white" onclick="assignTestVehicle()">ğŸš— Assign Test Vehicle</button>
                </div>
                <div id="carsList" class="car-grid"></div>
            </div>

            <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
            <div id="result"></div>
        </div>

        <script>
            const API = `http://${window.location.hostname}:4080`;
            let currentUser = null;

            function log(data) {
                document.getElementById('result').textContent = JSON.stringify(data, null, 2);
            }

            // ë¡œê·¸ì¸ API í…ŒìŠ¤íŠ¸
            async function login() {
                log({ message: 'Testing Login API...' });

                const res = await fetch(`${API}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: document.getElementById('loginUser').value,
                        password: document.getElementById('loginPass').value,
                    }),
                });
                const data = await res.json();
                log(data);

                if (res.ok && data.status === 'success') {
                    currentUser = data.user;
                    loadMyCars();
                }
            }

            // ì¸ì¦ ìƒíƒœ API í…ŒìŠ¤íŠ¸
            async function checkAuthStatus() {
                log({ message: 'Testing Auth Status API...' });

                const res = await fetch(`${API}/api/auth/status`, { credentials: 'include' });
                const data = await res.json();
                log(data);

                if (res.ok && data.authenticated) {
                    currentUser = data.user;
                }
            }

            // ì°¨ëŸ‰ ë“±ë¡ API í…ŒìŠ¤íŠ¸
            async function registerCarBySearch() {
                const vin = document.getElementById('searchVin').value.trim();
                const license = document.getElementById('searchLicense').value.trim();

                if (!vin && !license) {
                    log({ error: 'VIN number or license plate required' });
                    return;
                }

                const payload = {};
                if (vin) payload.vin = vin;
                if (license) payload.license_plate = license;

                log({ message: 'Testing Vehicle Registration API...', payload });

                const res = await fetch(`${API}/api/cars/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                log(data);

                if (res.ok) {
                    loadMyCars();
                    loadAvailableCars();
                    document.getElementById('searchVin').value = '';
                    document.getElementById('searchLicense').value = '';
                }
            }

            // ì°¨ëŸ‰ IDë¡œ ì§ì ‘ ë“±ë¡
            async function registerCarById(carId) {
                log({ message: 'Testing Vehicle Registration by ID...', car_id: carId });

                const res = await fetch(`${API}/api/cars/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ model_id: carId }),
                });
                const data = await res.json();
                log(data);

                if (res.ok) {
                    loadMyCars();
                    loadAvailableCars();
                }
            }

            // ë“±ë¡ ê°€ëŠ¥í•œ ì°¨ëŸ‰ ëª©ë¡ API í…ŒìŠ¤íŠ¸ (ìŠ¤í™ ì¡°íšŒë¡œ ëŒ€ì²´)
            async function loadAvailableCars() {
                log({ message: 'Testing Vehicle Specs API (Available Cars)...' });

                const res = await fetch(`${API}/api/vehicle-specs`, { credentials: 'include' });
                const data = await res.json();

                if (res.ok) {
                    displayAvailableCars(data.data);
                    document.getElementById('availableCarsSection').style.display = 'block';
                    log({ message: `Found ${data.data.length} vehicle specifications`, specs: data.data });
                } else {
                    log(data);
                }
            }

            // ë‚´ ì°¨ëŸ‰ ëª©ë¡ API í…ŒìŠ¤íŠ¸
            async function loadMyCars() {
                log({ message: 'Testing My Vehicles API...' });

                try {
                    const res = await fetch(`${API}/api/cars`, { credentials: 'include' });
                    const data = await res.json();

                    log({
                        message: 'API Response received',
                        status: res.status,
                        ok: res.ok,
                        data: data,
                    });

                    if (res.ok) {
                        displayCars(data.data || [], 'carsList');
                        log({ message: `Found ${(data.data || []).length} owned vehicles`, response: data });
                    } else {
                        log({ error: 'API call failed', status: res.status, data });
                    }
                } catch (error) {
                    log({ error: 'Network error', message: error.message });
                }
            }

            // ì°¨ëŸ‰ ì œì–´ API í…ŒìŠ¤íŠ¸
            async function controlCar(carId, action) {
                log({ message: 'Testing Vehicle Control API...', car_id: carId, action });

                const res = await fetch(`${API}/api/vehicle/${carId}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ command: action }),
                });
                const data = await res.json();
                log(data);

                if (res.ok) {
                    loadMyCars();
                }
            }

            // ì°¨ëŸ‰ ìƒíƒœ API í…ŒìŠ¤íŠ¸
            async function getCarStatus(carId) {
                log({ message: 'Testing Vehicle Status API...', car_id: carId });

                const res = await fetch(`${API}/api/vehicle/${carId}/status`, { credentials: 'include' });
                const data = await res.json();
                log(data);
            }

            // API í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
            async function testVehicleAPI() {
                log({ message: 'Testing all Vehicle APIs...' });
                await loadMyCars();
                await loadAvailableCars();
            }

            async function testCarAPIHealth() {
                log({ message: 'Testing Car-API Health...' });

                try {
                    const res = await fetch(`${API}/api/car-api/health`, { credentials: 'include' });
                    const data = await res.json();
                    log(data);
                } catch (error) {
                    log({ error: 'Car-API Health check failed', message: error.message });
                }
            }

            async function loadUserProfile() {
                log({ message: 'Testing User Profile API...' });
                const res = await fetch(`${API}/api/user/profile`, { credentials: 'include' });
                const data = await res.json();
                log(data);
            }

            // í…ŒìŠ¤íŠ¸ìš© ì°¨ëŸ‰ í• ë‹¹
            async function assignTestVehicle() {
                log({ message: 'Assigning test vehicle to current user...' });

                try {
                    const res = await fetch(`${API}/api/cars/assign-test-vehicle`, {
                        method: 'POST',
                        credentials: 'include',
                    });
                    const data = await res.json();

                    log(data);

                    if (res.ok) {
                        // í• ë‹¹ ì„±ê³µ í›„ ì°¨ëŸ‰ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        loadMyCars();
                    }
                } catch (error) {
                    log({ error: 'Test vehicle assignment failed', message: error.message });
                }
            }

            // ì°¨ëŸ‰ ìŠ¤í™ ëª©ë¡ í‘œì‹œ
            function displayAvailableCars(specs) {
                const container = document.getElementById('availableCarsList');
                if (!specs || specs.length === 0) {
                    container.innerHTML = '<p>No vehicle specifications</p>';
                    return;
                }

                container.innerHTML = specs
                    .map(
                        (spec) => `
                    <div class="car-card" style="border: 2px dashed #28a745;">
                        <h4>${spec.model} <span style="color: #28a745;">âœ¨ Available</span></h4>
                        <div class="car-info">Spec ID: ${spec.id}</div>
                        <div class="car-info">Category: ${spec.category || 'N/A'}</div>
                        <div class="car-info">Engine: ${spec.engine_type || 'N/A'}</div>
                        <div class="car-info">Power: ${spec.power || 'N/A'}</div>
                        <div class="controls" style="margin-top: 10px;">
                            <button class="btn btn-success" onclick="registerCarById(${spec.id})">Register Vehicle</button>
                        </div>
                    </div>
                `
                    )
                    .join('');
            }

            // ì°¨ëŸ‰ ëª©ë¡ í‘œì‹œ (ê°„í”Œ ë²„ì „)
            function displayCars(cars, containerId, showOwner = false) {
                const container = document.getElementById(containerId);
                if (!cars || cars.length === 0) {
                    container.innerHTML = '<p>No registered vehicles</p>';
                    return;
                }

                container.innerHTML = cars
                    .map((car) => {
                        const engineClass = car.engine_state === 'on' ? 'status-on' : 'status-off';
                        const doorClass = car.door_state === 'locked' ? 'status-locked' : 'status-unlocked';

                        return `
                    <div class="car-card">
                        <h4>${car.model} (${car.year || 'Unknown'})</h4>
                        <div class="car-info">ID: ${car.id}</div>
                        ${showOwner ? `<div class="car-info">Owner ID: ${car.owner_id}</div>` : ''}
                        <div class="car-info">VIN: ${car.vin || 'N/A'}</div>
                        <div class="car-info">License: ${car.license_plate || 'Unregistered'}</div>
                        <div class="car-info">Fuel: ${car.fuel || 0}% | Battery: ${car.battery || 12}V</div>
                        
                        <div class="car-status">
                            <span class="status-badge ${engineClass}">Engine ${car.engine_state === 'on' ? 'ON' : 'OFF'}</span>
                            <span class="status-badge ${doorClass}">Door ${car.door_state === 'locked' ? 'Locked' : 'Open'}</span>
                        </div>
                        
                        <div class="controls">
                            <button class="btn btn-success" onclick="controlCar(${car.id}, 'engine_start')">Start</button>
                            <button class="btn btn-danger" onclick="controlCar(${car.id}, 'engine_stop')">Stop</button>
                            <button class="btn btn-warning" onclick="controlCar(${car.id}, 'door_lock')">Lock</button>
                            <button class="btn btn-primary" onclick="controlCar(${car.id}, 'door_unlock')">Unlock</button>
                            <button class="btn" style="background:#6c757d;color:white;" onclick="getCarStatus(${car.id})">Status</button>
                        </div>
                    </div>
                `;
                    })
                    .join('');
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ìƒíƒœ í™•ì¸
            window.addEventListener('load', function () {
                checkAuthStatus();
            });
        </script>
    </body>
</html>
